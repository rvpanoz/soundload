{"version":3,"file":"archive.js","sourceRoot":"","sources":["../../src/targets/archive.ts"],"names":[],"mappings":"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","sourcesContent":["import { path7za } from \"7zip-bin\"\nimport { debug7z, debug7zArgs, isMacOsSierra, spawn } from \"electron-builder-util\"\nimport { computeEnv, getLinuxToolsPath } from \"electron-builder-util/out/bundledTool\"\nimport { exists } from \"electron-builder-util/out/fs\"\nimport { unlink } from \"fs-extra-p\"\nimport * as path from \"path\"\nimport { CompressionLevel } from \"../core\"\n\nclass CompressionDescriptor {\n  constructor(public flag: string, public env: string, public minLevel: string, public maxLevel: string = \"-9\") {\n  }\n}\n\nconst extToCompressionDescriptor: { [key: string]: CompressionDescriptor; } = {\n  \"tar.xz\": new CompressionDescriptor(\"--xz\", \"XZ_OPT\", \"-0\", \"-9e\"),\n  \"tar.lz\": new CompressionDescriptor(\"--lzip\", \"LZOP\", \"-0\"),\n  \"tar.gz\": new CompressionDescriptor(\"--gz\", \"GZIP\", \"-1\"),\n  \"tar.bz2\": new CompressionDescriptor(\"--bzip2\", \"BZIP2\", \"-1\"),\n}\n\n/** @internal */\nexport async function tar(compression: CompressionLevel | null | undefined, format: string, outFile: string, dirToArchive: string, isMacApp: boolean = false) {\n  // we don't use 7z here - develar: I spent a lot of time making pipe working - but it works on MacOS and often hangs on Linux (even if use pipe-io lib)\n  // and in any case it is better to use system tools (in the light of docker - it is not problem for user because we provide complete docker image).\n  const info = extToCompressionDescriptor[format]\n  let tarEnv = process.env\n  if (process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL != null) {\n    tarEnv = {...tarEnv}\n    tarEnv[info.env] = \"-\" + process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL\n  }\n  else if (compression != null && compression !== \"normal\") {\n    tarEnv = {...tarEnv}\n    tarEnv[info.env] = compression === \"store\" ? info.minLevel : info.maxLevel\n  }\n\n  const args = [info.flag, \"-cf\", outFile]\n  if (!isMacApp) {\n    args.push(\"--transform\", `s,^\\\\.,${path.basename(outFile, \".\" + format)},`)\n  }\n  args.push(isMacApp ? path.basename(dirToArchive) : \".\")\n\n  if (await isMacOsSierra()) {\n    const linuxToolsPath = await getLinuxToolsPath()\n    tarEnv = {\n      ...tarEnv,\n      PATH: computeEnv(process.env.PATH, [path.join(linuxToolsPath, \"bin\")]),\n      LANG: \"en_US.UTF-8\",\n      LC_CTYPE: \"UTF-8\"\n    }\n  }\n\n  await spawn(process.platform === \"darwin\" || process.platform === \"freebsd\" ? \"gtar\" : \"tar\", args, {\n    cwd: isMacApp ? path.dirname(dirToArchive) : dirToArchive,\n    env: tarEnv\n  })\n  return outFile\n}\n\nexport interface ArchiveOptions {\n  /**\n   * @default false\n   */\n  withoutDir?: boolean\n\n  /**\n   * @default true\n   */\n  solid?: boolean\n\n  listFile?: string\n\n  dictSize?: number\n  excluded?: Array<string>\n\n  method?: \"Copy\" | \"LZMA\"\n}\n\n// 7z is very fast, so, use ultra compression\n/** @internal */\nexport function addUltraArgs(args: Array<string>, options: ArchiveOptions) {\n  // https://stackoverflow.com/questions/27136783/7zip-produces-different-output-from-identical-input\n  // https://sevenzip.osdn.jp/chm/cmdline/switches/method.htm#7Z\n  // -mtm=off disable \"Stores last Modified timestamps for files.\"\n  // tc and ta are off by default, but to be sure, we explicitly set it to off\n  args.push(\"-mx=9\", `-md=${options.dictSize || 64}m`, `-ms=${options.solid === false ? \"off\" : \"on\"}`, \"-mtm=off\", \"-mtc=off\", \"-mta=off\")\n}\n\n/** @internal */\nexport function addZipArgs(args: Array<string>) {\n  // -mcu switch:  7-Zip uses UTF-8, if there are non-ASCII symbols.\n  // because default mode: 7-Zip uses UTF-8, if the local code page doesn't contain required symbols.\n  // but archive should be the same regardless where produced\n  args.push(\"-mcu\")\n  // disable \"Stores NTFS timestamps for files: Modification time, Creation time, Last access time.\" to produce the same archive for the same data\n  args.push(\"-mtc=off\")\n  args.push(\"-tzip\")\n}\n\n/** @internal */\nexport async function archive(compression: CompressionLevel | null | undefined, format: string, outFile: string, dirToArchive: string, options: ArchiveOptions = {}): Promise<string> {\n  let storeOnly = compression === \"store\"\n  const args = debug7zArgs(\"a\")\n  if (format === \"7z\" || format.endsWith(\".7z\")) {\n    if (process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL != null) {\n      storeOnly = false\n      args.push(`-mx=${process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL}`)\n    }\n    else if (!storeOnly) {\n      addUltraArgs(args, options)\n    }\n  }\n  else if (format === \"zip\" && compression === \"maximum\") {\n    // http://superuser.com/a/742034\n    args.push(\"-mfb=258\", \"-mpass=15\")\n  }\n  else if (process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL != null) {\n    storeOnly = false\n    args.push(`-mx=${process.env.ELECTRON_BUILDER_COMPRESSION_LEVEL}`)\n  }\n  else if (!storeOnly) {\n    args.push(\"-mx=9\")\n  }\n\n  // remove file before - 7z doesn't overwrite file, but update\n  try {\n    await unlink(outFile)\n  }\n  catch (e) {\n    // ignore\n  }\n\n  if (options.method != null) {\n    args.push(`-mm=${options.method}`)\n  }\n  else if (format === \"zip\" || storeOnly) {\n    args.push(\"-mm=\" + (storeOnly ? \"Copy\" : \"Deflate\"))\n  }\n\n  if (format === \"zip\") {\n    addZipArgs(args)\n  }\n\n  args.push(outFile, options.listFile == null ? (options.withoutDir ? \".\" : path.basename(dirToArchive)) : `@${options.listFile}`)\n  if (options.excluded != null) {\n    args.push(...options.excluded)\n  }\n\n  try {\n    await spawn(path7za, args, {\n      cwd: options.withoutDir ? dirToArchive : path.dirname(dirToArchive),\n    }, {isDebugEnabled: debug7z.enabled})\n  }\n  catch (e) {\n    if (e.code === \"ENOENT\" && !(await exists(dirToArchive))) {\n      throw new Error(`Cannot create archive: \"${dirToArchive}\" doesn't exist`)\n    }\n    else {\n      throw e\n    }\n  }\n\n  return outFile\n}"]}
